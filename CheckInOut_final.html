<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Entrée / Sortie Chantier</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .error { color: red; margin-top: 1em; }
        .success { color: green; margin-top: 1em; }
        textarea { width: 100%; height: 60px; }
        button { margin: 0.5em; }
        select { margin: 0.5em 0; }
    </style>
</head>
<body>
    <h2>Entrée / Sortie Chantier</h2>
    <div>
        Chantier : <b>FD10</b>
    </div>
    <div>
        <button id="btn-rentre">Je rentre</button>
        <button id="btn-sors">Je sors</button>
    </div>
    <button id="btn-admin">Accéder au mode admin</button>

    <h3>Choisissez un dossier SharePoint</h3>
    <form id="form-checkin">
        <label for="sharepoint">Dossier SharePoint :</label><br>
        <select id="sharepoint" name="sharepoint">
            <option value="">Chargement...</option>
        </select><br>
        <h3>Avant de partir</h3>
        <div>Pensez à récupérer votre cadenas de consignation.</div>
        <label for="obs">Observations sécurité :</label><br>
        <textarea id="obs" name="obs" placeholder="Ex : panneau à déplacer"></textarea><br>
        https://eramet.my.cority.com/#/homeDéclarer dans myCority</a><br><br>
        <button type="submit" id="envoyer">Envoyer</button>
    </form>
    <div id="message"></div>

    <script>
    // Remplace l'URL par celle de ton API SharePoint
    const apiSharePoint = 'https://votre-api-endpoint.com/api/sharepoint-folders';

    // Remplir le menu déroulant dynamiquement
    window.addEventListener('DOMContentLoaded', function() {
        const select = document.getElementById('sharepoint');
        fetch(apiSharePoint)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Impossible de charger les dossiers SharePoint');
                }
            })
            .then(data => {
                select.innerHTML = '<option value="">-- Sélectionnez --</option>';
                data.forEach(item => {
                    if (typeof item === 'object') {
                        select.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                    } else {
                        select.innerHTML += `<option value="${item}">${item}</option>`;
                    }
                });
            })
            .catch(error => {
                select.innerHTML = '<option value="">Erreur de chargement</option>';
                document.getElementById('message').textContent = error.message;
                document.getElementById('message').className = 'error';
            });
    });

    // Gestion de l'envoi du formulaire
    document.getElementById('form-checkin').addEventListener('submit', function(e) {
        e.preventDefault();
        const observation = document.getElementById('obs').value;
        const dossierSharePoint = document.getElementById('sharepoint').value;
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = '';
        messageDiv.className = '';

        fetch('https://votre-api-endpoint.com/checkin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                observation: observation,
                dossierSharePoint: dossierSharePoint
            })
        })
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                return response.text().then(text => {
                    throw new Error('La réponse du serveur n\'est pas du JSON : ' + text);
                });
            }
        })
        .then(data => {
            messageDiv.textContent = 'Succès : ' + JSON.stringify(data);
            messageDiv.className = 'success';
        })
        .catch(error => {
            messageDiv.textContent = 'Erreur : ' + error.message;
            messageDiv.className = 'error';
        });
    });

    // Redirection vers la page admin
    document.getElementById('btn-admin').addEventListener('click', function() {
        window.location.href = 'admin.html'; // Modifie cette URL si besoin
    });
    </script>
</body>
